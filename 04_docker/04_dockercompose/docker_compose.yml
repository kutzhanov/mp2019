version: '3.7'

services:
  # Docker Swarm service called 'balancer' with the configuration:
  balancer:
    #	based on Load Balancer image located in Docker Hub;
    image: kutzhanov/myapache:latest
    # port 80 is exposed;
    expose:
      - "80"
    # Apache configuration defined in Docker config;
    configs:
      - source: lb_config
        target: /etc/httpd/conf.d/
        mode: 655
    # located in 'frontend' network;
    networks:
      - frontend
    deploy:
      # the service has one replica;
      replicas: 1
      #	ensure that the service containers will be deployed only on nodes where 'role' label defined in 'front';
      placement:
        constraints:
          - node.labels.role == front
      # restart policy is 'on-failure';
      restart_policy:
        condition: on-failure
      resources:
        # reserve container resources by 25% of CPU and 256MB Memory;
        reservations:
          cpus: '0.25'
          memory: 256M
        # limit container resources by 50% of CPU and 512MB Memory;
        limits:
          cpus: '0.50'
          memory: 512M
      # add label 'service' with value 'load_balancer';
      labels:
        service: "load_balancer"

  # Docker Swarm service called 'web' with the configuration:
  web:
    # based on Web Server image located in Docker Hub;
    image: kutzhanov/myweb:latest
    # port 8080 is exposed;
    expose:
      - "8080"
    # Apache configuration for virtual host defined in Docker config;
    configs:
      - source: web_config
        target: /etc/httpd/conf/
        mode: 655
    #	located in 'frontend' and 'backend' networks;
    networks:
      - frontend
      - backend
    deploy:
      # the service has two replicas;
      replicas: 2
      #	ensure that the service containers will be deployed only on nodes where 'role' label defined in 'front';
      placement:
        constraints:
          - node.labels.role == front
      #	restart policy is 'on-failure';
      restart_policy:
        condition: on-failure
      resources:
        # reserve container resources by 25% of CPU and 256MB Memory;
        reservations:
          cpus: '0.25'
          memory: 256M
        #	limit container resources by 50% of CPU and 512MB Memory;
        limits:
          cpus: '0.50'
          memory: 512M
      # add label 'service' with value 'web_server';
      labels:
        service: "web_server"
    # mount 'web_data' volume into root directory according to virtual host configuration on the service containers;
    volumes:
      - type: volume
        source: web_data
        target: /var/www/mp2019/ # ???
    #	environment variables for MySQL user, password, database name and server name with values
    # defined in external Docker secrets exclude server name;
    # environment:
    #   MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
    #   MYSQL_DATABASE: wordpress
    #   MYSQL_USER: wordpress
    #   MYSQL_PASSWORD_FILE: /run/secrets/db_password
    secrets:
      - mysql_user
      - mysql_pass
      - mysql_root_pass
      - mysql_db

# Definitions for 'frontend' and 'backend' attacheble overlay networks;
networks:
  frontend:
    driver: overlay
    attachable: true
    name: frontend-overlay
  backend:
    driver: overlay
    attachable: true
    name: backend-overlay

# Definitions for external Docker secrets 'mysql_user', 'mysql_pass', 'mysql_root_pass' and 'mysql_db';
secrets:
  mysql_user:
    external: true
  mysql_pass:
    external: true
  mysql_root_pass:
    external: true
  mysql_db:
    external: true

# Definitions for Docker configs 'lb_config' and 'web_config' with Load Balancer Apache configuration
# and Web Server virtual host settings content;
configs:
  lb_config: # Load Balancer Apache configuration
  # Create Apache Load Balancer configuration which will balance traffic between 'web' service containers by Round Robin method.
    file: ../01_proxy/mod_proxy.conf
  web_config: # Web Server virtual host settings
    file: ../02_web/httpd.conf

# Definitions for 'web_data' volume
volumes: # same as docker volume create
  web_data:
